library(MonetDB.R)
con <- dbConnect(dbDriver("MonetDB"), "monetdb://localhost:50000/acs", "monetdb", "monetdb",timeout=100)

#teststr <- paste(rep("0123456789#",500),collapse="")
#identical(teststr,dbGetQuery(con,paste("SELECT '",teststr,"'",sep=""))[[1]])

# manually
#res <- dbSendQuery(con,"CREATE TABLE dummy (a varchar(5), b varchar(5))")
#res <- dbSendQuery(con,"INSERT INTO dummy (a,b) VALUES('FOO','BAR')")
#dbReadTable(con,"dummy")
#res <- dbSendQuery(con,"UPDATE dummy SET b='BAT' WHERE a='FOO'")
#dbReadTable(con,"dummy")
#res <- dbSendQuery(con,"delete from dummy")
#dbReadTable(con,"dummy")
#dbRemoveTable(con,"dummy")


# automagically
#c1 <- c("foo1","foo2","ev\"i'l")
#c2 <- as.integer(c(1,2,3))
#c3 <- c(1.1,2.2,3.3)
#c4 <- c(TRUE,FALSE,NA)
#data <- data.frame(c1,c2,c3,c4)
#names(data) <- c("by","select","group","type")
#data
#dbWriteTable(con,"dummy",data)
#dbReadTable(con,"dummy")
#dbRemoveTable(con,"dummy")

dbSendQuery(con,"create table _U_100034385e45 as (select idkey, (drinks_per_month01-0.403453609838529) *(1*( sex = 1 )) as _drinks_per_month01_1, (drinks_per_month02-0.255193269904596) *(1*( sex = 1 )) as _drinks_per_month02_1, (drinks_per_month03-0.113642439433348) *(1*( sex = 1 )) as _drinks_per_month03_1, (drinks_per_month04-0.101432384207422) *(1*( sex = 1 )) as _drinks_per_month04_1, (drinks_per_month05-0.126278296616184) *(1*( sex = 1 )) as _drinks_per_month05_1, (drinks_per_month01-0.5413034288029) *(1*( sex = 2 )) as _drinks_per_month01_2, (drinks_per_month02-0.280905313259248) *(1*( sex = 2 )) as _drinks_per_month02_2, (drinks_per_month03-0.0774685950594693) *(1*( sex = 2 )) as _drinks_per_month03_2, (drinks_per_month04-0.0494185216349015) *(1*( sex = 2 )) as _drinks_per_month04_2, (drinks_per_month05-0.0509041412434755) *(1*( sex = 2 )) as _drinks_per_month05_2 from recoded_b2010 inner join _mm_1000410b3097 using(idkey)) with data")
dbSendQuery(con,"create unique index idx100060b51ecb on  _U_100034385e45 (idkey)")


res <- dbSendQuery(con,"select avg(_s__drinks_per_month01_1), avg(_s__drinks_per_month02_1), avg(_s__drinks_per_month03_1), avg(_s__drinks_per_month04_1), avg(_s__drinks_per_month05_1), avg(_s__drinks_per_month01_2), avg(_s__drinks_per_month02_2), avg(_s__drinks_per_month03_2), avg(_s__drinks_per_month04_2), avg(_s__drinks_per_month05_2), avg(_s__drinks_per_month01_1*_s__drinks_per_month01_1), avg(_s__drinks_per_month02_1*_s__drinks_per_month01_1), avg(_s__drinks_per_month03_1*_s__drinks_per_month01_1), avg(_s__drinks_per_month04_1*_s__drinks_per_month01_1), avg(_s__drinks_per_month05_1*_s__drinks_per_month01_1), avg(_s__drinks_per_month01_2*_s__drinks_per_month01_1), avg(_s__drinks_per_month02_2*_s__drinks_per_month01_1), avg(_s__drinks_per_month03_2*_s__drinks_per_month01_1), avg(_s__drinks_per_month04_2*_s__drinks_per_month01_1), avg(_s__drinks_per_month05_2*_s__drinks_per_month01_1), avg(_s__drinks_per_month01_1*_s__drinks_per_month02_1), avg(_s__drinks_per_month02_1*_s__drinks_per_month02_1), avg(_s__drinks_per_month03_1*_s__drinks_per_month02_1), avg(_s__drinks_per_month04_1*_s__drinks_per_month02_1), avg(_s__drinks_per_month05_1*_s__drinks_per_month02_1), avg(_s__drinks_per_month01_2*_s__drinks_per_month02_1), avg(_s__drinks_per_month02_2*_s__drinks_per_month02_1), avg(_s__drinks_per_month03_2*_s__drinks_per_month02_1), avg(_s__drinks_per_month04_2*_s__drinks_per_month02_1), avg(_s__drinks_per_month05_2*_s__drinks_per_month02_1), avg(_s__drinks_per_month01_1*_s__drinks_per_month03_1), avg(_s__drinks_per_month02_1*_s__drinks_per_month03_1), avg(_s__drinks_per_month03_1*_s__drinks_per_month03_1), avg(_s__drinks_per_month04_1*_s__drinks_per_month03_1), avg(_s__drinks_per_month05_1*_s__drinks_per_month03_1), avg(_s__drinks_per_month01_2*_s__drinks_per_month03_1), avg(_s__drinks_per_month02_2*_s__drinks_per_month03_1), avg(_s__drinks_per_month03_2*_s__drinks_per_month03_1), avg(_s__drinks_per_month04_2*_s__drinks_per_month03_1), avg(_s__drinks_per_month05_2*_s__drinks_per_month03_1), avg(_s__drinks_per_month01_1*_s__drinks_per_month04_1), avg(_s__drinks_per_month02_1*_s__drinks_per_month04_1), avg(_s__drinks_per_month03_1*_s__drinks_per_month04_1), avg(_s__drinks_per_month04_1*_s__drinks_per_month04_1), avg(_s__drinks_per_month05_1*_s__drinks_per_month04_1), avg(_s__drinks_per_month01_2*_s__drinks_per_month04_1), avg(_s__drinks_per_month02_2*_s__drinks_per_month04_1), avg(_s__drinks_per_month03_2*_s__drinks_per_month04_1), avg(_s__drinks_per_month04_2*_s__drinks_per_month04_1), avg(_s__drinks_per_month05_2*_s__drinks_per_month04_1), avg(_s__drinks_per_month01_1*_s__drinks_per_month05_1), avg(_s__drinks_per_month02_1*_s__drinks_per_month05_1), avg(_s__drinks_per_month03_1*_s__drinks_per_month05_1), avg(_s__drinks_per_month04_1*_s__drinks_per_month05_1), avg(_s__drinks_per_month05_1*_s__drinks_per_month05_1), avg(_s__drinks_per_month01_2*_s__drinks_per_month05_1), avg(_s__drinks_per_month02_2*_s__drinks_per_month05_1), avg(_s__drinks_per_month03_2*_s__drinks_per_month05_1), avg(_s__drinks_per_month04_2*_s__drinks_per_month05_1), avg(_s__drinks_per_month05_2*_s__drinks_per_month05_1), avg(_s__drinks_per_month01_1*_s__drinks_per_month01_2), avg(_s__drinks_per_month02_1*_s__drinks_per_month01_2), avg(_s__drinks_per_month03_1*_s__drinks_per_month01_2), avg(_s__drinks_per_month04_1*_s__drinks_per_month01_2), avg(_s__drinks_per_month05_1*_s__drinks_per_month01_2), avg(_s__drinks_per_month01_2*_s__drinks_per_month01_2), avg(_s__drinks_per_month02_2*_s__drinks_per_month01_2), avg(_s__drinks_per_month03_2*_s__drinks_per_month01_2), avg(_s__drinks_per_month04_2*_s__drinks_per_month01_2), avg(_s__drinks_per_month05_2*_s__drinks_per_month01_2), avg(_s__drinks_per_month01_1*_s__drinks_per_month02_2), avg(_s__drinks_per_month02_1*_s__drinks_per_month02_2), avg(_s__drinks_per_month03_1*_s__drinks_per_month02_2), avg(_s__drinks_per_month04_1*_s__drinks_per_month02_2), avg(_s__drinks_per_month05_1*_s__drinks_per_month02_2), avg(_s__drinks_per_month01_2*_s__drinks_per_month02_2), avg(_s__drinks_per_month02_2*_s__drinks_per_month02_2), avg(_s__drinks_per_month03_2*_s__drinks_per_month02_2), avg(_s__drinks_per_month04_2*_s__drinks_per_month02_2), avg(_s__drinks_per_month05_2*_s__drinks_per_month02_2), avg(_s__drinks_per_month01_1*_s__drinks_per_month03_2), avg(_s__drinks_per_month02_1*_s__drinks_per_month03_2), avg(_s__drinks_per_month03_1*_s__drinks_per_month03_2), avg(_s__drinks_per_month04_1*_s__drinks_per_month03_2), avg(_s__drinks_per_month05_1*_s__drinks_per_month03_2), avg(_s__drinks_per_month01_2*_s__drinks_per_month03_2), avg(_s__drinks_per_month02_2*_s__drinks_per_month03_2), avg(_s__drinks_per_month03_2*_s__drinks_per_month03_2), avg(_s__drinks_per_month04_2*_s__drinks_per_month03_2), avg(_s__drinks_per_month05_2*_s__drinks_per_month03_2), avg(_s__drinks_per_month01_1*_s__drinks_per_month04_2), avg(_s__drinks_per_month02_1*_s__drinks_per_month04_2), avg(_s__drinks_per_month03_1*_s__drinks_per_month04_2), avg(_s__drinks_per_month04_1*_s__drinks_per_month04_2), avg(_s__drinks_per_month05_1*_s__drinks_per_month04_2), avg(_s__drinks_per_month01_2*_s__drinks_per_month04_2), avg(_s__drinks_per_month02_2*_s__drinks_per_month04_2), avg(_s__drinks_per_month03_2*_s__drinks_per_month04_2), avg(_s__drinks_per_month04_2*_s__drinks_per_month04_2), avg(_s__drinks_per_month05_2*_s__drinks_per_month04_2), avg(_s__drinks_per_month01_1*_s__drinks_per_month05_2), avg(_s__drinks_per_month02_1*_s__drinks_per_month05_2), avg(_s__drinks_per_month03_1*_s__drinks_per_month05_2), avg(_s__drinks_per_month04_1*_s__drinks_per_month05_2), avg(_s__drinks_per_month05_1*_s__drinks_per_month05_2), avg(_s__drinks_per_month01_2*_s__drinks_per_month05_2), avg(_s__drinks_per_month02_2*_s__drinks_per_month05_2), avg(_s__drinks_per_month03_2*_s__drinks_per_month05_2), avg(_s__drinks_per_month04_2*_s__drinks_per_month05_2), avg(_s__drinks_per_month05_2*_s__drinks_per_month05_2), count(*) as _n_, 0 as _fpc_, xststr
                      from 
                            (select xststr, sum(_drinks_per_month01_1*xfinalwt) as _s__drinks_per_month01_1, sum(_drinks_per_month02_1*xfinalwt) as _s__drinks_per_month02_1, sum(_drinks_per_month03_1*xfinalwt) as _s__drinks_per_month03_1, sum(_drinks_per_month04_1*xfinalwt) as _s__drinks_per_month04_1, sum(_drinks_per_month05_1*xfinalwt) as _s__drinks_per_month05_1, sum(_drinks_per_month01_2*xfinalwt) as _s__drinks_per_month01_2, sum(_drinks_per_month02_2*xfinalwt) as _s__drinks_per_month02_2, sum(_drinks_per_month03_2*xfinalwt) as _s__drinks_per_month03_2, sum(_drinks_per_month04_2*xfinalwt) as _s__drinks_per_month04_2, sum(_drinks_per_month05_2*xfinalwt) as _s__drinks_per_month05_2, 0 from recoded_b2010 inner join _U_100034385e45 using(idkey) group by xststr, xpsu)  as r_temp
                      group by xststr")

d <- fetch(res,-1)
str(d)
